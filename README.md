# üöÄ DevOps Challenge - FastAPI + Jenkins + Cloud Run

## üìã Resumen del Proyecto
Pipeline completo de CI/CD que despliega autom√°ticamente una aplicaci√≥n FastAPI en Google Cloud Run usando Jenkins.

### üèóÔ∏è Arquitectura
```
Developer ‚Üí GitHub ‚Üí Jenkins (VM) ‚Üí Artifact Registry ‚Üí Cloud Run
    ‚Üì           ‚Üì         ‚Üì              ‚Üì              ‚Üì
  git push   webhook   build image   store image   deploy app
```

---

## üõ†Ô∏è Preparaci√≥n Inicial

### 1. Instalar Herramientas Locales (Ubuntu)
```bash
# Actualizar sistema
sudo apt update && sudo apt upgrade -y

# Instalar herramientas esenciales
sudo apt install -y git curl wget unzip build-essential

# Instalar Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
newgrp docker

# Instalar Google Cloud SDK
curl https://sdk.cloud.google.com | bash
exec -l $SHELL
gcloud init

# Instalar Terraform
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install terraform
```

### 2. Configurar GCP
```bash
# Autenticarse con GCP
gcloud auth login

# Establecer proyecto
gcloud config set project nombre-de-tu-proyecto

# Habilitar APIs necesarias
gcloud services enable compute.googleapis.com
gcloud services enable artifactregistry.googleapis.com
gcloud services enable run.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable iam.googleapis.com
```

---

## üîí Configuraci√≥n Segura (SIN terraform.tfvars)

### ‚ö†Ô∏è IMPORTANTE: Protecci√≥n de Informaci√≥n Sensible

Este proyecto est√° configurado para **NO usar terraform.tfvars** y evitar cualquier leak de informaci√≥n sensible.

### 1. Configurar .gitignore (Protecci√≥n de Archivos)
```bash
# Clonar repositorio
git clone https://github.com/zagalx90/devops-fundamentals.git
cd devops-fundamentals

# Crear/actualizar .gitignore para proteger archivos sensibles
cat >> .gitignore << 'EOF'

# Archivos de Python
__pycache__/
*.py[cod]

# Credenciales y configuraci√≥n sensible
*.json
*.key
*.pem
terraform.tfvars
terraform.tfvars.backup

# Estado de Terraform
*.tfstate
*.tfstate.*
.terraform/
.terraform.lock.hcl

# Jenkins
jenkins-sa-key.json
jenkins-github-key*
EOF
```

### 2. Crear Template de Configuraci√≥n (Para Desarrollo Local)
```bash
# Crear archivo de ejemplo (sin informaci√≥n sensible)
cat > terraform/terraform.tfvars.example << 'EOF'
# terraform.tfvars.example
# 
# üìã INSTRUCCIONES PARA DESARROLLO LOCAL:
# 1. Copia: cp terraform.tfvars.example terraform.tfvars  
# 2. Completa con valores reales
# 3. NUNCA subas terraform.tfvars al repositorio
#
# üîí En Jenkins se usan variables de entorno TF_VAR_*

project_id   = "tu-proyecto-gcp-aqui"
region       = "us-east1"
zone         = "us-east1-b"
name_prefix  = "jenkins"
machine_type = "e2-medium"
boot_disk_gb = 30
env          = "dev"
owner        = "tu-nombre"
EOF
```

---

## üîß Despliegue de Infraestructura

### M√©todo 1: Usando Variables de Entorno (Recomendado)
```bash
cd terraform

# Configurar variables de entorno (Terraform las lee autom√°ticamente)
export TF_VAR_project_id="nombre-de-tu-proyecto"
export TF_VAR_env="dev" 
export TF_VAR_owner="tu-nombre"

# Inicializar Terraform
terraform init

# Verificar configuraci√≥n
terraform validate

# Ver plan de ejecuci√≥n (mostrar√° las variables)
terraform plan

# Aplicar cambios (crear infraestructura)
terraform apply
# Escribir 'yes' cuando se solicite confirmaci√≥n
```

### M√©todo 2: Para Desarrollo Local (Opcional)
```bash
# Solo si quieres usar archivo local (no subir al repo)
cd terraform
cp terraform.tfvars.example terraform.tfvars

# Editar con valores reales
nano terraform.tfvars

# Ejecutar terraform
terraform init
terraform plan
terraform apply
```

### 3. Guardar Informaci√≥n de la Infraestructura
```bash
# Ver la gu√≠a paso a paso que aparecer√° autom√°ticamente
terraform output step_by_step_guide

# Guardar outputs importantes
terraform output jenkins_url
terraform output service_account_email
```

---

## üîë Configuraci√≥n de Credenciales

### 1. Crear Service Account Key para Jenkins
```bash
# Obtener email de la service account (desde output de terraform)
SA_EMAIL=$(terraform output -raw service_account_email)

# Crear clave JSON para Jenkins
gcloud iam service-accounts keys create jenkins-sa-key.json \
  --iam-account="$SA_EMAIL"

echo "‚úÖ jenkins-sa-key.json creado - GUARDALO EN LUGAR SEGURO"
echo "‚ö†Ô∏è  Este archivo NO se sube al repositorio (protegido por .gitignore)"
```

### 2. Crear SSH Key para GitHub
```bash
# Generar par de claves SSH para Jenkins
ssh-keygen -t rsa -b 4096 -C "jenkins@nombre-de-tu-proyecto" -f jenkins-github-key -N ""

echo "‚úÖ Claves SSH creadas:"
echo "  - jenkins-github-key (clave privada - para Jenkins)"
echo "  - jenkins-github-key.pub (clave p√∫blica - para GitHub)"

# Mostrar clave p√∫blica para agregar a GitHub
echo ""
echo "üîë CLAVE P√öBLICA para GitHub (copia todo el contenido):"
cat jenkins-github-key.pub
```

### 3. Agregar SSH Key a GitHub
1. Ve a GitHub ‚Üí Settings ‚Üí SSH and GPG keys
2. Click "New SSH key"
3. Title: `Jenkins DevOps Server`
4. Key: pega el contenido de `jenkins-github-key.pub`
5. Click "Add SSH key"

---

## ‚öôÔ∏è Configuraci√≥n de Jenkins

### 1. Acceder a Jenkins
```bash
# Obtener URL y contrase√±a inicial
terraform output jenkins_url
terraform output initial_jenkins_password_command

# Ejecutar comando para obtener contrase√±a
terraform output -raw initial_jenkins_password_command | bash
```

### 2. Configuraci√≥n Inicial de Jenkins
1. **Abrir Jenkins** en el navegador
2. **Ingresar contrase√±a inicial**
3. **Instalar plugins sugeridos**
4. **Crear usuario administrador**:
   - Username: `admin`
   - Password: `admin123` (cambiar en producci√≥n)
   - Full name: `Jenkins Admin`
   - Email: tu-email@example.com

### 3. Configurar Variables de Entorno en Jenkins (CR√çTICO)

#### üîí Configuraci√≥n de Variables Seguras:
1. **Ir a**: Manage Jenkins ‚Üí Configure System
2. **Buscar "Global properties"**
3. **Environment variables** ‚òëÔ∏è (marcar checkbox)
4. **Agregar variables**:
   - `TF_VAR_project_id` = `nombre-de-tu-proyecto`
   - `TF_VAR_env` = `dev`
   - `TF_VAR_owner` = `jenkins-pipeline`
5. **Save**

### 4. Configurar Credenciales en Jenkins

#### A. Credencial para GCP Service Account
1. **Ir a**: Manage Jenkins ‚Üí Manage Credentials ‚Üí System ‚Üí Global credentials
2. **Add Credentials** ‚Üí **Secret file**
   - **ID**: `gcp-sa-key`
   - **Description**: `GCP Service Account Key`
   - **File**: subir `jenkins-sa-key.json`
   - Click **OK**

#### B. Credencial para Project ID
1. **Add Credentials** ‚Üí **Secret text**
   - **ID**: `gcp-project-id`
   - **Description**: `GCP Project ID`
   - **Secret**: `nombre-de-tu-proyecto`
   - Click **OK**

#### C. Credencial SSH para GitHub
1. **Add Credentials** ‚Üí **SSH Username with private key**
   - **ID**: `github-ssh-key`
   - **Description**: `GitHub SSH Key`
   - **Username**: `git`
   - **Private Key**: seleccionar "Enter directly"
   - Pegar contenido del archivo `jenkins-github-key` (sin extensi√≥n)
   - Click **OK**

### 5. Instalar Plugins Necesarios
1. **Ir a**: Manage Jenkins ‚Üí Manage Plugins ‚Üí Available
2. **Buscar e instalar**:
   - `AnsiColor` (para colores en consola - usado en Jenkinsfile)
   - `Google Cloud Build`
   - `Docker Pipeline`
   - `Pipeline: Stage View`
   - `Blue Ocean` (interfaz moderna)
3. **Restart Jenkins**: Manage Jenkins ‚Üí Restart Safely

---

## üîÑ Configuraci√≥n del Pipeline

### 1. Crear Job en Jenkins
1. **New Item**
2. **Nombre**: `fastapi-cloud-run-pipeline`
3. **Tipo**: Pipeline
4. Click **OK**

### 2. Configurar Pipeline
1. **En "Pipeline" section**:
   - **Definition**: Pipeline script from SCM
   - **SCM**: Git
   - **Repository URL**: `git@github.com:xfelp/devops-essentials.git`
   - **Credentials**: seleccionar `github-ssh-key`
   - **Branch**: `*/main`
   - **Script Path**: `api/Jenkinsfile`

2. **En "Build Triggers"**:
   - ‚òëÔ∏è GitHub hook trigger for GITScm polling

3. **Click "Save"**

### 3. Configurar Webhook en GitHub
1. **Ir al repositorio** en GitHub
2. **Settings** ‚Üí **Webhooks** ‚Üí **Add webhook**
3. **Payload URL**: `http://TU_JENKINS_IP:8080/github-webhook/`
   ```bash
   # Para obtener la IP de Jenkins:
   terraform output jenkins_external_ip
   ```
4. **Content type**: `application/json`
5. **Which events**: "Just the push event"
6. **Active**: ‚òëÔ∏è
7. Click **Add webhook**

---

## üß™ Probar el Pipeline

### 1. Ejecutar Pipeline Manualmente
1. En Jenkins, ir al job `fastapi-cloud-run-pipeline`
2. Click **"Build Now"**
3. Observar logs en tiempo real (con colores gracias a AnsiColor)

### 2. Verificar Despliegue
```bash
# Obtener URL del servicio desplegado
gcloud run services describe fastapi-demo \
  --region=us-east1 \
  --format='value(status.url)'

# Probar endpoints
SERVICE_URL=$(gcloud run services describe fastapi-demo --region=us-east1 --format='value(status.url)')
curl $SERVICE_URL/
curl $SERVICE_URL/ping
curl $SERVICE_URL/healthz
```

### 3. Probar Trigger Autom√°tico
```bash
# Hacer un cambio en el c√≥digo y push
cd api/app
echo "# Updated $(date)" >> main.py
git add .
git commit -m "test: trigger pipeline automatically"
git push origin main

# El pipeline deber√≠a ejecutarse autom√°ticamente en Jenkins
```

---

## üîç Troubleshooting

### Variables de Entorno
```bash
# Verificar variables en Jenkins VM
gcloud compute ssh jenkins-vm --zone=us-east1-b --command='env | grep TF_VAR'

# Si las variables no est√°n, configurarlas en Jenkins UI
```

### Problemas Comunes

#### 1. Terraform no encuentra project_id
```bash
# Verificar variables de entorno
echo $TF_VAR_project_id

# Si est√° vac√≠a, configurar:
export TF_VAR_project_id="nombre-de-tu-proyecto"

# O configurar en Jenkins UI (recomendado)
```

#### 2. Jenkins no puede acceder a GitHub
```bash
# Verificar SSH key
gcloud compute ssh jenkins-vm --zone=us-east1-b
sudo -u jenkins ssh -T git@github.com
```

#### 3. Error de permisos en GCP
```bash
# Verificar service account
gcloud projects get-iam-policy nombre-de-tu-proyecto \
  --flatten="bindings[].members" \
  --format="table(bindings.role)" \
  --filter="bindings.members:*jenkins-sa*"
```

#### 4. Artifact Registry no funciona
```bash
# Verificar repositorio
gcloud artifacts repositories describe apps --location=us-east1

# Verificar permisos
gcloud artifacts repositories get-iam-policy apps --location=us-east1
```

### Comandos √ötiles de Debugging
```bash
# Ver logs de Jenkins
gcloud compute ssh jenkins-vm --zone=us-east1-b \
  --command='sudo journalctl -u jenkins -f'

# Estado de servicios
gcloud compute ssh jenkins-vm --zone=us-east1-b \
  --command='sudo systemctl status jenkins docker'

# Verificar Terraform en Jenkins
gcloud compute ssh jenkins-vm --zone=us-east1-b \
  --command='sudo -u jenkins terraform version'

# Ver im√°genes Docker construidas
gcloud compute ssh jenkins-vm --zone=us-east1-b \
  --command='sudo docker images'

# Ver servicios Cloud Run
gcloud run services list --region=us-east1

# Ver logs de Cloud Run
gcloud run services logs tail fastapi-demo --region=us-east1
```

---

## üîí Caracter√≠sticas de Seguridad Implementadas

### ‚úÖ Informaci√≥n Protegida
- **terraform.tfvars** nunca se crea ni se sube al repo
- **Credenciales JSON** protegidas por .gitignore
- **SSH keys** protegidas por .gitignore
- **Variables sensibles** solo en Jenkins UI

### ‚úÖ Variables de Entorno
- Terraform lee autom√°ticamente `TF_VAR_*`
- Jenkins gestiona variables de forma segura
- Separaci√≥n entre desarrollo local y CI/CD

### ‚úÖ Mejores Pr√°cticas
- Service account con permisos m√≠nimos necesarios
- Firewall configurado solo para puertos necesarios
- Backend de Terraform local (para desarrollo)
- Rotaci√≥n de credenciales recomendada

---

## üßπ Limpieza de Recursos

```bash
# Eliminar servicio de Cloud Run
gcloud run services delete fastapi-demo --region=us-east1 --quiet

# Eliminar im√°genes de Artifact Registry
gcloud artifacts docker images delete \
  us-east1-docker.pkg.dev/nombre-de-tu-proyecto/apps/fastapi-demo --quiet

# Eliminar infraestructura con Terraform
cd terraform
# Configurar variables si es necesario
export TF_VAR_project_id="nombre-de-tu-proyecto"
terraform destroy
# Escribir 'yes' cuando se solicite

# Limpiar archivos locales (solo si existen)
rm -f jenkins-sa-key.json
rm -f jenkins-github-key*
rm -f terraform/terraform.tfvars
```

---

## üìö Diferencias Clave con Configuraci√≥n Tradicional

### ‚ùå M√©todo Tradicional (NO Recomendado)
```bash
# Crea archivo con informaci√≥n sensible
cat > terraform.tfvars << EOF
project_id = "nombre-de-tu-proyecto"  # ‚ö†Ô∏è Informaci√≥n sensible
EOF

# ‚ùå Riesgo: terraform.tfvars puede subirse accidentalmente al repo
```

### ‚úÖ M√©todo Seguro (Implementado)
```bash
# Variables de entorno (no van al repo)
export TF_VAR_project_id="nombre-de-tu-proyecto"

# ‚úÖ Terraform funciona igual, pero sin archivos sensibles
terraform plan
```

---

## üìà Pr√≥ximas Mejoras

### Seguridad Avanzada
- [ ] Backend remoto en GCS para estado de Terraform
- [ ] Terraform Workspaces para m√∫ltiples entornos
- [ ] Vault para gesti√≥n de secretos
- [ ] Renovaci√≥n autom√°tica de credenciales

### Pipeline Avanzado
- [ ] Tests automatizados (pytest)
- [ ] M√∫ltiples entornos (dev/staging/prod)
- [ ] Rollback autom√°tico si fallan tests
- [ ] Notificaciones Slack/Email

### Monitoreo
- [ ] Prometheus + Grafana
- [ ] Alertas proactivas
- [ ] M√©tricas de aplicaci√≥n
- [ ] Logs centralizados

---

## üÜò Soporte

Si encuentras problemas:

1. **Revisa variables de entorno** en Jenkins
2. **Verifica .gitignore** protege archivos sensibles
3. **Confirma APIs habilitadas** en GCP
4. **Usa comandos de debugging** proporcionados
5. **Consulta logs espec√≠ficos** de cada servicio

**¬°Felicitaciones por implementar un pipeline DevOps seguro y profesional!** üéâ

---

## üéØ Resumen de Comandos Esenciales

```bash
# 1. Configuraci√≥n inicial
export TF_VAR_project_id="nombre-de-tu-proyecto"
cd terraform && terraform init && terraform apply

# 2. Crear credenciales
gcloud iam service-accounts keys create jenkins-sa-key.json --iam-account=$(terraform output -raw service_account_email)
ssh-keygen -t rsa -b 4096 -C "jenkins" -f jenkins-github-key -N ""

# 3. Obtener info de Jenkins
terraform output jenkins_url
terraform output -raw initial_jenkins_password_command | bash

# 4. Verificar despliegue
gcloud run services describe fastapi-demo --region=us-east1 --format='value(status.url)'

# 5. Limpiar (cuando termines)
terraform destroy
```

**¬°Tu pipeline est√° listo y es completamente seguro!** üöÄüîí
